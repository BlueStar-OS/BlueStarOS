#任务切换
.altmacro
.macro SAVE_GPN n 
    sd s\n,(\n+2)*8(a0)
.endm
.macro REFUME_GPN n 
    ld s\n,(\n+2)*8(a1)
.endm

.section .text.switch
.global __switch


#################################################################################
# 任务上下文描述的是任务的全程执行状态，不分内核态和用户态
# 主要保存用户程序 ra（函数返回地址（调用__switch的下一条指令）） sp(栈指针（目前为内核栈指针）) 剩余的called保存的寄存器（任务完整状态）  
# 保存被换出的任务上下文到 a0(被换出的任务的任务上下文指针) 任务上下文保存在任务的内核栈里面
__switch:
    #保存s0-s11 called registers
    sd ra,(a0) #保存ra
    sd sp,8(a0)
    .set n , 0
.rept 12
    SAVE_GPN %n
    .set n ,n+1
.endr
##################################################################################



# 注意！ sys_clone 后的任务会从这里开始入. 
############################################################################################
# 恢复执行任务 恢复程序的执行状态 会从ra返回继续运行（目前为返回内核(__switch下一条指令)）
# a1为被换入任务的任务上下文指针，在该任务的内核栈中
.set n,0
.rept 12
    REFUME_GPN %n
    .set n,n+1
.endr
    ld ra,(a1) 
    ld sp,8(a1) # 被换出时的指针



    ret# 依赖ra
#switch本质是任务状态切换，地址空间切换等移动到trap->特权级的切换
#############################################################################################